@let filteredFormFieldStates = filteredFormFieldStates$ | async;

@if (filteredFormFieldStates) {
  @for (fieldState of filteredFormFieldStates; track fieldState.attribute) {
    <kc-group-label [attribute]="fieldState.attribute" />

    @if (beforeField) {
      <ng-container
        [ngTemplateOutlet]="beforeField"
        [ngTemplateOutletContext]="{
          attribute: fieldState.attribute,
          valueOrValues: fieldState.valueOrValues,
          displayableErrors: fieldState.displayableErrors,
        }"
      />
    }

    <div
      [kcClass]="'kcFormGroupClass'"
      [style.display]="
        fieldState.attribute.annotations.inputType === 'hidden' ||
        (fieldState.attribute.name === 'password-confirm' && !doMakeUserConfirmPassword)
          ? 'none'
          : 'block'
      "
    >
      <div [kcClass]="'kcLabelWrapperClass'">
        <label
          [for]="fieldState.attribute.name"
          [kcClass]="'kcLabelClass'"
          style="display: block; margin-bottom: 0.25rem"
        >
          {{ i18n.advancedMsgStr(fieldState.attribute.displayName ?? '') }}
          @if (fieldState.attribute.required) {
            *
          }
          <kc-field-errors
            [attribute]="fieldState.attribute"
            [displayableErrors]="fieldState.displayableErrors"
          />
        </label>

        @if (fieldState.attribute.name === 'password') {
          <p style="font-size: 0.75rem; margin: 0.25rem 0 0 0; color: #6c757d">
            La contraseña debe tener mínimo 8 dígitos, incluir mayúsculas, minúsculas, números y al menos un carácter
            especial.
          </p>
        }
      </div>

      <div [kcClass]="'kcInputWrapperClass'">
        @if (fieldState.attribute.annotations.inputHelperTextBefore) {
          <div
            aria-live="polite"
            [kcClass]="'kcInputHelperTextBeforeClass'"
            [id]="'form-help-text-before-' + fieldState.attribute.name"
          >
            {{ i18n.advancedMsgStr(fieldState.attribute.annotations.inputHelperTextBefore) }}
          </div>
        }

        <kc-input-field-by-type
          [attribute]="fieldState.attribute"
          [valueOrValues]="fieldState.valueOrValues"
          [displayableErrors]="fieldState.displayableErrors"
          (dispatchFormAction)="onDispatch($event)"
        />

        @if (fieldState.attribute.annotations.inputHelperTextAfter) {
          <div
            aria-live="polite"
            [kcClass]="'kcInputHelperTextAfterClass'"
            [id]="'form-help-text-after-' + fieldState.attribute.name"
          >
            {{ i18n.advancedMsgStr(fieldState.attribute.annotations.inputHelperTextAfter) }}
          </div>
        }

        @if (afterField) {
          <ng-container
            [ngTemplateOutlet]="afterField"
            [ngTemplateOutletContext]="{
              attribute: fieldState.attribute,
              valueOrValues: fieldState.valueOrValues,
              displayableErrors: fieldState.displayableErrors,
            }"
          />
        }
      </div>
    </div>
  }
}
